# -*- coding: utf-8 -*-
"""
Generated by ArcGIS ModelBuilder on : 2023-09-25 16:31:40
"""
from ast import If
import bxarcpy


def main(工作空间=r"C:\Users\common\project\J江东区临江控规\临江控规_数据库.gdb", 区域要素名称="JX_工业片区范围线", 单元名称="临江单元", 地块要素名称="DIST_用地规划图", 设施要素名称="SS_配套设施"):
    with bxarcpy.环境.环境管理器(临时工作空间=工作空间, 工作空间=工作空间):
        # To allow overwriting outputs change overwriteOutput option to True.
        bxarcpy.配置.是否覆盖输出要素 = True
        区域要素 = bxarcpy.要素类.要素读取_通过名称(区域要素名称)
        区域要素 = 区域要素.要素创建_通过复制并重命名重名要素("XG_GYPQ")
        区域要素.字段添加("DYMC", "字符串", 50, "规划编制单元名称").字段计算("DYMC", f"'{单元名称}'")
        区域要素.字段添加("PQBM", "字符串", 20, "工业片区编码").字段计算("PQBM", "!区域编号!")
        区域要素.字段添加("PQMC", "字符串", 50, "工业片区名称").字段计算("PQMC", "!区域名称!")
        区域要素.字段添加("PQMJ", "双精度", 50, "片区面积").字段计算("PQMJ", "round(!Shape_Area!/10000, 2)")

        需操作的字段名称列表 = ["地类编号", "所属工业片区", "Shape_Area", "地块建筑面积", "工业建筑面积"]
        统计数据 = {}
        地块要素 = bxarcpy.要素类.要素读取_通过名称(地块要素名称)
        with bxarcpy.游标类.游标创建_通过名称("查找", 地块要素.名称, 需操作的字段名称列表) as 游标:
            for x in 游标:
                if x["所属工业片区"] != "":
                    if x["所属工业片区"] not in 统计数据:
                        统计数据[x["所属工业片区"]] = {}
                    from bxpy import 转换, 字

                    if "总工业用地面积" not in 统计数据[x[f"所属工业片区"]]:
                        统计数据[x["所属工业片区"]]["总工业用地面积"] = 0

                    if "总工业建筑面积" not in 统计数据[x[f"所属工业片区"]]:
                        统计数据[x["所属工业片区"]]["总工业建筑面积"] = 0

                    if 字.匹配正则(x["地类编号"], "^(10|11).*"):
                        统计数据[x["所属工业片区"]]["总工业用地面积"] += 转换.转浮(x["Shape_Area"])
                        统计数据[x["所属工业片区"]]["总工业建筑面积"] += 转换.转浮(x["工业建筑面积"])

        区域要素.字段添加("YDZL", "双精度", 50, f"工业用地总量")
        区域要素.字段添加("JZZL", "双精度", 50, f"工业建筑总量")

        需操作的字段名称列表 = ["区域编号", "YDZL", "JZZL"]
        with bxarcpy.游标类.游标创建_通过名称("更新", 区域要素.名称, 需操作的字段名称列表) as 游标:
            for x in 游标:
                if x["区域编号"] in 统计数据:
                    x["YDZL"] = round(统计数据[x["区域编号"]]["总工业用地面积"] / 10000, 2)
                    x["JZZL"] = round(统计数据[x["区域编号"]]["总工业建筑面积"] / 10000, 2)
                游标.行更新(x)

        区域要素.字段添加("ZDGN", "字符串", 255, "产业主导功能").字段计算("ZDGN", "!区域主导属性!")

        需操作的字段名称列表 = ["设施类型", "设施名称", "设施数量", "设施规模", "所属工业片区"]
        统计数据 = {}
        设施要素 = bxarcpy.要素类.要素读取_通过名称(设施要素名称)
        with bxarcpy.游标类.游标创建_通过名称("查找", 设施要素.名称, 需操作的字段名称列表) as 游标:
            from bxpy import 转换

            for x in 游标:
                if x["所属工业片区"] not in ["", None]:
                    if x["所属工业片区"] not in 统计数据:
                        统计数据[x["所属工业片区"]] = {}
                    if x["设施类型"] in ["教育", "商服", "社会福利", "社区治理", "生态环境", "体育", "文化", "医疗"]:
                        if "配套设施汇总" not in 统计数据[x["所属工业片区"]]:
                            统计数据[x["所属工业片区"]]["配套设施汇总"] = {}
                        if x["设施名称"] not in 统计数据[x["所属工业片区"]]["配套设施汇总"]:
                            统计数据[x["所属工业片区"]]["配套设施汇总"][x["设施名称"]] = [转换.转浮(x["设施数量"]), x["设施规模"]]
                        else:
                            统计数据[x["所属工业片区"]]["配套设施汇总"][x["设施名称"]][0] += 转换.转浮(x["设施数量"])
                            if x["设施规模"] not in ["", " ", None] and 统计数据[x["所属工业片区"]]["配套设施汇总"][x["设施名称"]][1] not in ["", " ", None]:
                                统计数据[x["所属工业片区"]]["配套设施汇总"][x["设施名称"]][1] += "、" + x["设施规模"]
                            elif x["设施规模"] not in ["", " ", None] and 统计数据[x["所属工业片区"]]["配套设施汇总"][x["设施名称"]][1] in ["", " ", None]:
                                统计数据[x["所属工业片区"]]["配套设施汇总"][x["设施名称"]][1] += x["设施规模"]
                    elif x["设施类型"] in ["市政交通"]:
                        if "交通设施汇总" not in 统计数据[x["所属工业片区"]]:
                            统计数据[x["所属工业片区"]]["交通设施汇总"] = {}
                        if x["设施名称"] not in 统计数据[x["所属工业片区"]]["交通设施汇总"]:
                            统计数据[x["所属工业片区"]]["交通设施汇总"][x["设施名称"]] = [转换.转浮(x["设施数量"]), x["设施规模"]]
                        else:
                            统计数据[x["所属工业片区"]]["交通设施汇总"][x["设施名称"]][0] += 转换.转浮(x["设施数量"])
                            if x["设施规模"] not in ["", " ", None] and 统计数据[x["所属工业片区"]]["交通设施汇总"][x["设施名称"]][1] not in ["", " ", None]:
                                统计数据[x["所属工业片区"]]["交通设施汇总"][x["设施名称"]][1] += "、" + x["设施规模"]
                            elif x["设施规模"] not in ["", " ", None] and 统计数据[x["所属工业片区"]]["交通设施汇总"][x["设施名称"]][1] in ["", " ", None]:
                                统计数据[x["所属工业片区"]]["交通设施汇总"][x["设施名称"]][1] += x["设施规模"]
                    elif x["设施类型"] in ["市政防灾", "市政公用", "市政环卫", "市政人防", "市政消防"]:
                        if "市政设施汇总" not in 统计数据[x["所属工业片区"]]:
                            统计数据[x["所属工业片区"]]["市政设施汇总"] = {}
                        if x["设施名称"] not in 统计数据[x["所属工业片区"]]["市政设施汇总"]:
                            统计数据[x["所属工业片区"]]["市政设施汇总"][x["设施名称"]] = [转换.转浮(x["设施数量"]), x["设施规模"]]
                        else:
                            统计数据[x["所属工业片区"]]["市政设施汇总"][x["设施名称"]][0] += 转换.转浮(x["设施数量"])
                            if x["设施规模"] not in ["", " ", None] and 统计数据[x["所属工业片区"]]["市政设施汇总"][x["设施名称"]][1] not in ["", " ", None]:
                                统计数据[x["所属工业片区"]]["市政设施汇总"][x["设施名称"]][1] += "、" + x["设施规模"]
                            elif x["设施规模"] not in ["", " ", None] and 统计数据[x["所属工业片区"]]["市政设施汇总"][x["设施名称"]][1] in ["", " ", None]:
                                统计数据[x["所属工业片区"]]["市政设施汇总"][x["设施名称"]][1] += x["设施规模"]

        区域要素.字段添加("PTSS", "字符串", 255, "配套设施")
        区域要素.字段添加("PTSS2", "字符串", 255, "配套设施2")
        区域要素.字段添加("PTSS3", "字符串", 255, "配套设施3")
        区域要素.字段添加("JTSS", "字符串", 255, "道路与交通设施")
        区域要素.字段添加("JTSS2", "字符串", 255, "道路与交通设施2")
        区域要素.字段添加("SZSS", "字符串", 255, "市政设施")
        区域要素.字段添加("SZSS2", "字符串", 255, "市政设施2")
        区域要素.字段添加("SZSS3", "字符串", 255, "市政设施3")

        需操作的字段名称列表 = ["区域编号", "PTSS", "PTSS2", "PTSS3", "JTSS", "JTSS2", "SZSS", "SZSS2", "SZSS3"]
        配套设施超510flag = False
        配套设施超255flag = False
        交通设施超255flag = False
        市政设施超510flag = False
        市政设施超255flag = False

        with bxarcpy.游标类.游标创建_通过名称("更新", 区域要素.名称, 需操作的字段名称列表) as 游标:
            for x in 游标:
                if x["区域编号"] in 统计数据:
                    if "配套设施汇总" in 统计数据[x["区域编号"]]:
                        配套设施汇总字符串 = "" + "刚性管控：配置"
                        # print(统计数据[x["区域编号"]]["配套设施汇总"])
                        for k, v in 统计数据[x["区域编号"]]["配套设施汇总"].items():
                            if v[1] in ["", " ", None]:
                                配套设施汇总字符串 += k + str(int(v[0])) + "处；"
                            else:
                                配套设施汇总字符串 += k + str(int(v[0])) + "处，规模分别为" + v[1] + "；"
                        配套设施汇总字符串 = 配套设施汇总字符串[0:-1]
                        if len(配套设施汇总字符串) > 510:
                            x["PTSS"] = 配套设施汇总字符串[0:255]
                            x["PTSS2"] = 配套设施汇总字符串[255:510]
                            x["PTSS3"] = 配套设施汇总字符串[510:]
                            配套设施超510flag = True
                            配套设施超255flag = True
                        elif len(配套设施汇总字符串) > 255:
                            x["PTSS"] = 配套设施汇总字符串[0:255]
                            x["PTSS2"] = 配套设施汇总字符串[255:]
                            配套设施超255flag = True
                        else:
                            x["PTSS"] = 配套设施汇总字符串

                    if "交通设施汇总" in 统计数据[x["区域编号"]]:
                        交通设施汇总字符串 = "" + "刚性管控：配置"
                        for k, v in 统计数据[x["区域编号"]]["交通设施汇总"].items():
                            if v[1] in ["", " ", None]:
                                交通设施汇总字符串 += k + str(int(v[0])) + "处；"
                            else:
                                交通设施汇总字符串 += k + str(int(v[0])) + "处，规模分别为" + v[1] + "；"
                        交通设施汇总字符串 = 交通设施汇总字符串[0:-1]
                        if len(交通设施汇总字符串) > 255:
                            x["JTSS"] = 交通设施汇总字符串[0:255]
                            x["JTSS2"] = 交通设施汇总字符串[255:]
                            交通设施超255flag = True
                        else:
                            x["JTSS"] = 交通设施汇总字符串

                    if "市政设施汇总" in 统计数据[x["区域编号"]]:
                        市政设施汇总字符串 = "" + "刚性管控：配置"
                        for k, v in 统计数据[x["区域编号"]]["市政设施汇总"].items():
                            if v[1] in ["", " ", None]:
                                市政设施汇总字符串 += k + str(int(v[0])) + "处；"
                            else:
                                市政设施汇总字符串 += k + str(int(v[0])) + "处，规模分别为" + v[1] + "；"
                        市政设施汇总字符串 = 市政设施汇总字符串[0:-1]
                        if len(市政设施汇总字符串) > 510:
                            x["SZSS"] = 市政设施汇总字符串[0:255]
                            x["SZSS2"] = 市政设施汇总字符串[255:510]
                            x["SZSS3"] = 市政设施汇总字符串[510:]
                            市政设施超510flag = True
                            市政设施超255flag = True
                        elif len(市政设施汇总字符串) > 255:
                            x["SZSS"] = 市政设施汇总字符串[0:255]
                            x["SZSS2"] = 市政设施汇总字符串[255:]
                            市政设施超255flag = True
                        else:
                            x["SZSS"] = 市政设施汇总字符串

                游标.行更新(x)

        # 街区范围要素.字段添加("规划编制单元编号", "字符串", 20, "规划编制单元编号").字段计算("规划编制单元编号", 单元编号)
        # 街区范围要素.字段添加("批复时间", "日期", None, "批复时间").字段计算("批复时间", 批复时间)
        # 街区范围要素.字段添加("批复文号", "字符串", 50, "批复文号").字段计算("批复文号", 批复文号)
        # 街区范围要素.字段添加("编制单位", "字符串", 255, "编制单位").字段计算("编制单位", 编制单位)

        # 街区范围要素.字段添加("单元功能", "字符串", 255, "单元功能").字段计算("单元功能", 单元功能)
        # 街区范围要素.字段添加("人口规模", "双精度", 50, "人口规模").字段计算("人口规模", 人口规模)
        # 街区范围要素.字段添加("备注", "字符串", 255, "备注")
        区域要素.字段添加("BZ", "字符串", 255, "备注")

        区域要素.字段删除([f"区域编号"])
        区域要素.字段删除([f"区域名称"])
        区域要素.字段删除([f"区域主导属性"])

        if 配套设施超510flag is not True:
            区域要素.字段删除(["PTSS3"])
        if 配套设施超255flag is not True:
            区域要素.字段删除(["PTSS2"])

        if 交通设施超255flag is not True:
            区域要素.字段删除(["JTSS2"])

        if 市政设施超510flag is not True:
            区域要素.字段删除(["SZSS3"])
        if 市政设施超255flag is not True:
            区域要素.字段删除(["SZSS2"])


if __name__ == "__main__":
    # main(工作空间=r"C:\Users\common\project\J江东区临江控规\临江控规_数据库.gdb", 区域要素名称="JX_工业片区范围线", 单元名称="临江单元", 地块要素名称="DIST_用地规划图", 设施要素名称="SS_配套设施")
    main(工作空间=r"C:\Users\common\project\F富阳受降控规\受降北_数据库.gdb", 区域要素名称="JX_工业片区范围线", 单元名称="受降北单元", 地块要素名称="DIST_用地规划图", 设施要素名称="SS_配套设施")
