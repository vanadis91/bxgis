# -*- coding: utf-8 -*-
"""
Generated by ArcGIS ModelBuilder on : 2023-09-25 16:31:40
"""
import bxarcpy


def main(工作空间=r"C:\Users\common\project\J江东区临江控规\临江控规_数据库.gdb", 地块要素名称="DIST_用地规划图", 单元名称="临江单元", 批复时间="", 批复文号=""):
    with bxarcpy.环境.环境管理器(临时工作空间=工作空间, 工作空间=工作空间):
        bxarcpy.配置.是否覆盖输出要素 = True

        地块要素 = bxarcpy.要素类.要素读取_通过名称(地块要素名称)
        地块要素 = 地块要素.要素创建_通过复制()

        需操作的字段名称列表 = ["地块编号"]
        地块编号最大值字典 = {}
        with bxarcpy.游标类.游标创建_通过名称("查找", 地块要素.名称, 需操作的字段名称列表) as 游标:
            for x in 游标:
                if x["地块编号"] not in ["", " ", None]:
                    地块编号序号 = int(x["地块编号"].split("-")[1])
                    地块所属街坊 = x["地块编号"].split("-")[0]
                    if 地块所属街坊 in 地块编号最大值字典:
                        地块编号最大值字典[地块所属街坊] = max(地块编号最大值字典[地块所属街坊], 地块编号序号)
                    else:
                        地块编号最大值字典[地块所属街坊] = 地块编号序号

        print(f"地块编号最大值字典：{地块编号最大值字典}")

        河道要素 = 地块要素.要素创建_通过筛选("地类编号 LIKE '1701%'")
        河道要素 = 河道要素.要素创建_通过融合(["地类编号", "所属街坊"]).要素创建_通过多部件至单部件().要素几何修复()
        河道要素.字段添加("地块编号")
        需操作的字段名称列表 = ["地块编号", "所属街坊"]
        with bxarcpy.游标类.游标创建_通过名称("更新", 河道要素.名称, 需操作的字段名称列表) as 游标:
            for x in 游标:
                地块编号最大值字典[x["所属街坊"]] += 1
                x["地块编号"] = x["所属街坊"] + "-" + str(地块编号最大值字典[x["所属街坊"]]).zfill(2)

                游标.行更新(x)
        地块要素 = 地块要素.要素创建_通过更新并合并字段(河道要素.名称)

        # 道路要素.要素创建_通过联合([街坊范围线])
        道路要素 = 地块要素.要素创建_通过筛选("地类编号 LIKE '1207%' Or 地类编号 LIKE '060102%' Or 地类编号 LIKE '1202%'")
        道路要素 = 道路要素.要素创建_通过融合(["地类编号", "所属街坊", "地块性质别称"], 是否单部件=False).要素几何修复()
        道路要素.字段计算("地块编号", "!所属街坊! + '-' + !地块性质别称!")
        地块要素 = 地块要素.要素创建_通过更新并合并字段(道路要素.名称)

        地块要素 = 地块要素.要素创建_通过筛选("地块编号 <> ''")

        # 融合后要素 = 地块要素.要素创建_通过融合(None).要素创建_通过多部件至单部件().要素几何修复()
        # 融合后要素.字段添加("建设边界编号")
        # 需操作的字段名称列表 = ["建设边界编号"]
        # 编号 = 1
        # with bxarcpy.游标类.游标创建_通过名称("更新", 融合后要素.名称, 需操作的字段名称列表) as 游标:
        #     for x in 游标:
        #         x["建设边界编号"] = 单元编号 + "-" + "JSBJ" + str(编号).zfill(2)
        #         编号 += 1
        #         游标.行更新(x)
        # 融合后要素.字段删除(["ORIG_FID", "ORIG_FID_1"])

        地块要素 = 地块要素.要素创建_通过复制并重命名重名要素("XG_GHDK")
        地块要素.字段添加("DYMC", "字符串", 50, "规划编制单元名称").字段计算("DYMC", f"'{单元名称}'")
        地块要素.字段添加("PFSJ", "日期", None, "批复时间").字段计算("PFSJ", f"'{批复时间}'")
        地块要素.字段添加("PFWH", "字符串", 50, "批复文号").字段计算("PFWH", f"'{批复文号}'")
        地块要素.字段添加("DKBH", "字符串", 50, "地块编号").字段计算("DKBH", "!地块编号!")
        地块要素.字段添加("DLDM", "字符串", 255, "地类代码").字段计算("DLDM", "!地类编号!")
        地块要素.字段添加("DLMC", "字符串", 255, "地类名称").字段计算("DLMC", "!性质名称!")
        地块要素.字段添加("DLBM", "字符串", 100, "地类编码").字段计算("DLBM", "!地块性质别称!")
        地块要素.字段添加("ZDLDM", "字符串", 10, "主地类代码").字段计算("ZDLDM", '!地类编号!.split("/")[0]')
        地块要素.字段添加("JRBL", "字符串", 10, "用地兼容比例")
        地块要素.字段添加("MJ", "双精度", 50, "用地面积").字段计算("MJ", "round(!Shape_Area!/10000, 2)")
        地块要素.字段添加("RJL", "单精度", 50, "容积率")
        地块要素.字段添加("LDL", "单精度", 50, "绿地率")
        地块要素.字段添加("JZMD", "单精度", 50, "建筑密度")
        地块要素.字段添加("JZGD", "单精度", 50, "建筑高度")
        地块要素.字段添加("XGLX", "字符串", 20, "限高类型")
        地块要素.字段添加("FJSS1", "字符串", 255, "附建设施1")
        地块要素.字段添加("FJSS2", "字符串", 255, "附建设施2")
        地块要素.字段添加("GXYQ", "字符串", 255, "城市设计刚性要求")
        地块要素.字段添加("TXYQ", "字符串", 255, "城市设计弹性要求")
        地块要素.字段添加("GHDT", "字符串", 10, "规划动态")
        地块要素.字段添加("XZYD", "字符串", 255, "选择用地")
        地块要素.字段添加("TDM", "字符串", 50, "土地码")
        地块要素.字段添加("BZ", "字符串", 255, "备注").字段计算("BZ", "!备注说明!")

        需操作的字段名称列表 = ["XGLX", "绝对高度", "配套设施规模", "FJSS1", "FJSS2", "开发动态", "GHDT", "地块编号", "TDM", "地类编号", "所属街区", "所属街坊", "BZ", "备注说明", "兼容比例", "JRBL", "RJL", "容积率", "LDL", "绿地率", "JZMD", "建筑密度", "JZGD", "建筑限高"]
        # for x in 需操作的字段名称列表:
        #     if x not in 地块要素.字段名称列表获取():
        #         print(f"该地类在要素中没有{x}")
        with bxarcpy.游标类.游标创建_通过名称("更新", 地块要素.名称, 需操作的字段名称列表) as 游标:
            for x in 游标:
                if x["地类编号"] in ["1207", "1202", "060102", "1701"]:
                    break
                if x["绝对高度"] in ["51.7", "65", "156.7"]:
                    x["XGLX"] = "机场限高"
                    if x["备注说明"] in ["", " ", None]:
                        x["BZ"] = f'限高{x["绝对高度"]}米（1985国家高程基准）'
                    else:
                        x["BZ"] = x["备注说明"] + f'，限高{x["绝对高度"]}米（1985国家高程基准）'
                if len(x["配套设施规模"]) > 255:
                    x["FJSS1"] = x["配套设施规模"][0:255]
                    x["FJSS2"] = x["配套设施规模"][255:]
                else:
                    x["FJSS1"] = x["配套设施规模"]
                if x["开发动态"] in ["现状已实施"]:
                    x["GHDT"] = "保留"
                elif x["开发动态"] in ["", " ", None] and x["地块编号"] not in ["", " ", None]:
                    x["GHDT"] = "新建"
                if x["地块编号"] not in ["", " ", None]:
                    主地类编号 = x["地类编号"].split("/")[0]
                    兼容性质数量 = len(x["地类编号"].split("/"))
                    街区编号 = x["所属街区"][-2:]
                    街坊编号 = x["所属街坊"][-2:]
                    地块编号 = x["地块编号"].split("-")[1].zfill(3)

                    土地码 = "H09009006" + 主地类编号.rjust(8, "0") + f"X{兼容性质数量}" + 街区编号 + 街坊编号 + 地块编号 + "0"
                    x["TDM"] = 土地码
                if x["兼容比例"] not in ["", " ", None]:
                    x["JRBL"] = x["兼容比例"].split("/")[0] + ":" + x["兼容比例"].split("/")[1]
                if x["容积率"] not in ["", " ", None]:
                    x["RJL"] = float(x["容积率"])
                else:
                    x["RJL"] = 0.0
                if x["绿地率"] not in ["", " ", None]:
                    x["LDL"] = float(x["绿地率"])
                else:
                    x["LDL"] = 0.0
                if x["建筑密度"] not in ["", " ", None]:
                    x["JZMD"] = float(x["建筑密度"])
                else:
                    x["JZMD"] = 0.0
                if x["建筑限高"] not in ["", " ", None]:
                    x["JZGD"] = float(x["建筑限高"])
                else:
                    x["JZGD"] = 0.0

                游标.行更新(x)

        地块要素.字段删除(保留字段名称列表=["DYMC", "PFSJ", "PFWH", "DKBH", "DLDM", "DLMC", "DLBM", "ZDLDM", "JRBL", "MJ", "RJL", "LDL", "JZMD", "JZGD", "XGLX", "FJSS1", "FJSS2", "GXYQ", "TXYQ", "GHDT", "XZYD", "TDM", "BZ"])


def 生成土地码(工作空间=r"C:\Users\common\project\J江东区临江控规\临江控规_数据库.gdb", 地块要素名称="XG_GHDK"):
    with bxarcpy.环境.环境管理器(临时工作空间=工作空间, 工作空间=工作空间):
        bxarcpy.配置.是否覆盖输出要素 = True
        地块要素 = bxarcpy.要素类.要素读取_通过名称(地块要素名称)
        地块要素 = 地块要素.要素创建_通过复制()
        需操作的字段名称列表 = ["dkbh", "dldm", "tdm"]
        with bxarcpy.游标类.游标创建_通过名称("更新", 地块要素.名称, 需操作的字段名称列表) as 游标:
            for x in 游标:
                if x["dkbh"] not in ["", " ", None] and len(x["dkbh"].split("-")) == 2:
                    主地类编号 = x["dldm"].split("/")[0]
                    兼容性质数量 = len(x["dldm"].split("/"))
                    街区编号 = x["dkbh"][4:6]
                    街坊编号 = x["dkbh"][6:8]
                    地块编号 = x["dkbh"].split("-")[-1].zfill(3)
                elif x["dkbh"] not in ["", " ", None] and len(x["dkbh"].split("-")) == 3:
                    主地类编号 = x["dldm"].split("/")[0]
                    兼容性质数量 = len(x["dldm"].split("/"))
                    街区编号 = "00"
                    街坊编号 = "00"
                    地块编号 = x["dkbh"].split("-")[-1].zfill(3)

                土地码 = "H11006215" + 主地类编号.rjust(8, "0") + f"X{兼容性质数量}" + 街区编号 + 街坊编号 + 地块编号 + "0"
                x["tdm"] = 土地码
                游标.行更新(x)
        地块要素.要素创建_通过复制并重命名重名要素(地块要素名称)


if __name__ == "__main__":
    # main(工作空间=r"C:\Users\common\project\J江东区临江控规\临江控规_数据库.gdb", 地块要素名称="DIST_用地规划图", 单元名称="临江单元", 批复时间="", 批复文号="")
    生成土地码(工作空间=r"C:\Users\common\project\F富阳受降控规\受降北_数据库.gdb", 地块要素名称="XG_GHDK")
